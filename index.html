<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>LOG-BOOK PEMAKAIAN PUNCH DAN DIES</title>
  <style>
    body {
      font-family: "Courier New", monospace;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-weight: bold;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .logo {
      display: block;
      margin: 0 auto 10px auto;
      max-width: 90px;
    }
    label, select {
      font-size: 16px;
      font-weight: bold;
      margin-right: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      font-weight: bold;
    }
    th, td {
      border: 2px solid #888;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #ddd;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      border: none;
      background-color: transparent;
      text-align: center;
      font-weight: bold;
      padding: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    #notif {
      margin-top: 10px;
      font-size: 14px;
      color: green;
      font-weight: bold;
    }
  </style>

  <!-- Tambahkan pustaka jsPDF & autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

  <img src="images/rama_transparan.png" alt="Logo Perusahaan" class="logo">
  <h1>LOG-BOOK PEMAKAIAN PUNCH DAN DIES - NBL PRODUKSI</h1>

  <div class="top-bar">
    <div>
      <label for="monthSelect">Pilih Bulan:</label>
      <select id="monthSelect" onchange="loadMonthData()">
        <option value="Januari">Januari</option>
        <option value="Februari">Februari</option>
        <option value="Maret">Maret</option>
        <option value="April">April</option>
        <option value="Mei">Mei</option>
        <option value="Juni">Juni</option>
        <option value="Juli">Juli</option>
        <option value="Agustus">Agustus</option>
        <option value="September">September</option>
        <option value="Oktober">Oktober</option>
        <option value="November">November</option>
        <option value="Desember">Desember</option>
      </select>
    </div>
  </div>

  <table id="usageTable">
    <thead>
      <tr>
        <th>Penggunaan Produk</th>
        <th>Nomor Batch</th>
        <th>Mesin</th>
        <th>Tanggal Penggunaan</th>
        <th>Tanggal Pengembalian</th>
        <th>ACC SPV</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addRow()">Tambah Baris</button>
  <button onclick="manualSave()">üíæ Simpan Semua</button>
  <button onclick="exportToPDF()">üìÑ Export PDF</button>

  <div id="notif"></div>

  <script>
    const tableBody = document.querySelector("#usageTable tbody");
    const monthSelect = document.getElementById("monthSelect");
    const notif = document.getElementById("notif");
    const PASSWORD = "22"; // Ganti password penghapus baris di sini

    function getCurrentMonthKey() {
      return "NotePlusData_" + monthSelect.value;
    }

    function saveCurrentMonthData() {
      let data = [];
      for (let row of tableBody.rows) {
        const [produk, batch, mesin, tglPakai, tglKembali, acc] = [
          row.cells[0].querySelector('input')?.value || "",
          row.cells[1].querySelector('input')?.value || "",
          row.cells[2].querySelector('select')?.value || "",
          row.cells[3].querySelector('input')?.value || "",
          row.cells[4].querySelector('input')?.value || "",
          row.cells[5].querySelector('input')?.checked || false
        ];
        data.push({ produk, batch, mesin, tglPakai, tglKembali, acc });
      }
      localStorage.setItem(getCurrentMonthKey(), JSON.stringify(data));
    }

    function loadMonthData() {
      tableBody.innerHTML = "";
      let stored = JSON.parse(localStorage.getItem(getCurrentMonthKey()) || "[]");
      stored.forEach(data => insertRow(data, false));
      if (stored.length === 0) addRow();
    }

    function insertRow(data = {}, editable = true) {
      const row = tableBody.insertRow();
      const createInput = (type, value, editable) =>
        `<input type="${type}" value="${value || ""}" ${type !== "checkbox" ? (editable ? '' : 'readonly') : (editable ? '' : 'disabled')}
        ${type === "checkbox" ? 'onchange="handleCheck(this)"' : 'oninput="saveCurrentMonthData()"'}>`;

      row.insertCell(0).innerHTML = createInput("text", data.produk, editable);
      row.insertCell(1).innerHTML = createInput("text", data.batch, editable);
      row.insertCell(2).innerHTML = `
        <select ${editable ? 'onchange="saveCurrentMonthData()"' : 'disabled'}>
          <option value="">-- Pilih Mesin --</option>
          <option value="Kilian" ${data.mesin === "Kilian" ? "selected" : ""}>Kilian</option>
          <option value="Cadpress" ${data.mesin === "Cadpress" ? "selected" : ""}>Cadpress</option>
          <option value="Cadmach 1" ${data.mesin === "Cadmach 1" ? "selected" : ""}>Cadmach 1</option>
          <option value="Cadmach 3" ${data.mesin === "Cadmach 3" ? "selected" : ""}>Cadmach 3</option>
          <option value="PTK 3000" ${data.mesin === "PTK 3000" ? "selected" : ""}>PTK 3000</option>
          <option value="Rimex" ${data.mesin === "Rimex" ? "selected" : ""}>Rimex</option>
          <option value="Gylongli" ${data.mesin === "Gylongli" ? "selected" : ""}>Gylongli</option>
        </select>`;
      row.insertCell(3).innerHTML = createInput("date", data.tglPakai, editable);
      row.insertCell(4).innerHTML = createInput("date", data.tglKembali, editable);
      row.insertCell(5).innerHTML = createInput("checkbox", null, editable);
      row.insertCell(6).innerHTML = `
        <button onclick="toggleEdit(this)">${editable ? "üíæ Simpan" : "Ô∏è Edit"}</button>
        <button onclick="deleteRow(this)">X Hapus</button>`;

      const inputTglKembali = row.cells[4].querySelector('input');
      inputTglKembali.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          toggleLockRow(row);
          saveCurrentMonthData();
          addRow();
        }
      });
    }

    function toggleLockRow(row) {
      row.querySelectorAll('input, select').forEach(el => {
        if (el.type !== "checkbox") el.readOnly = true;
        el.disabled = true;
      });
      const actionBtn = row.cells[6].querySelector("button");
      if (actionBtn) actionBtn.innerText = "Ô∏è Edit";
    }

    function handleCheck(checkbox) {
      const row = checkbox.closest("tr");
      toggleLockRow(row);
      saveCurrentMonthData();
    }

    function toggleEdit(btn) {
      const row = btn.closest("tr");
      const editing = btn.innerText.includes("Edit");
      row.querySelectorAll('input, select').forEach(el => {
        if (el.type !== "checkbox") el.readOnly = !editing;
        el.disabled = !editing;
      });
      btn.innerText = editing ? "Simpan" : "Ô∏è Edit";
      if (!editing) saveCurrentMonthData();
    }

    function deleteRow(btn) {
      const pass = prompt("Masukkan password untuk hapus baris:");
      if (pass === PASSWORD) {
        btn.closest("tr").remove();
        saveCurrentMonthData();
        notif.innerText = "‚úîÔ∏è Baris dihapus.";
      } else {
        alert("X Password salah. Baris tidak dihapus.");
      }
    }

    function addRow() {
      insertRow({}, true);
    }

    function manualSave() {
      saveCurrentMonthData();
      notif.innerText = "‚úîÔ∏è Semua data berhasil disimpan ^_^.";
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("Courier", "bold");
      doc.setFontSize(14);
      doc.text("LOGBOOK PEMAKAIAN PUNCH DAN DIES - NBL PRODUKSI", 15, 15);

      const data = [];
      for (let row of tableBody.rows) {
        const [produk, batch, mesin, tglPakai, tglKembali, acc] = [
          row.cells[0].querySelector('input')?.value || "",
          row.cells[1].querySelector('input')?.value || "",
          row.cells[2].querySelector('select')?.value || "",
          row.cells[3].querySelector('input')?.value || "",
          row.cells[4].querySelector('input')?.value || "",
          row.cells[5].querySelector('input')?.checked ? "‚úì" : ""
        ];
        data.push([produk, batch, mesin, tglPakai, tglKembali, acc]);
      }

      doc.autoTable({
        head: [["Penggunaan Produk", "Nomor Batch", "Mesin", "Tanggal Penggunaan", "Tanggal Pengembalian", "ACC SPV"]],
        body: data,
        startY: 25,
        styles: { font: "courier", fontSize: 10 },
        headStyles: { fillColor: [220, 220, 220] },
      });

      const filename = "Logbook_Punch_Dies_" + monthSelect.value + ".pdf";
      doc.save(filename);
    }

    window.onload = () => {
      monthSelect.selectedIndex = new Date().getMonth();
      loadMonthData();
    };

    window.onbeforeunload = saveCurrentMonthData;
  </script>
</body>
</html>
